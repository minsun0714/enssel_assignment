<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default}">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn3.devexpress.com/jslib/24.2.5/css/dx.light.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="dx-viewport">
<div layout:fragment="content">
    <div class="content container-fluid">
        <div>ì‚¬ìš©ì í˜ì´ì§€</div>
        <div class="box">
            <div class="box-header with-bordered">
                <div class="box-body">
                    <button id="fetchUser" onclick="fetchTableData()">ì¡°íšŒ</button>
                    <button id="openRegisterModal">ë“±ë¡</button>
                    <button id="openModifyModal">ìˆ˜ì •</button>
                    <button id="deleteUser">ì‚­ì œ</button>
                </div>
                <table id="dataGrid">
                    <thead id="data-table-header"></thead>
                    <tbody id="data-table-body"></tbody>
                </table>
            </div>

        </div>
    </div>
</div>

<!-- ì‚¬ìš©ì ë“±ë¡ ëª¨ë‹¬ -->
<div class="modal fade" id="userRegisterModal" tabindex="-1" role="dialog" aria-labelledby="userRegisterModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userRegisterModalLabel">ì‚¬ìš©ì ë“±ë¡</h5>
                <button type="button" aria-label="Close" class="closeModalBtn">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="userRegisterForm">
                    <div class="form-group">
                        <label for="userName">ì´ë¦„</label>
                        <input type="text" class="form-control" id="userName" placeholder="ì´ë¦„ ì…ë ¥">
                    </div>
                    <div class="form-group">
                        <label for="userEmail">ì•„ì´ë””</label>
                        <input type="text" class="form-control" id="userEmail" placeholder="ì•„ì´ë”” ì…ë ¥">
                    </div>
                    <div class="form-group">
                        <label for="userPassword">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" class="form-control" id="userPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="closeRegisterModal">ë‹«ê¸°</button>
                <button type="button" class="btn btn-primary" id="saveUserBtn">ë“±ë¡</button>
            </div>
        </div>
    </div>
</div>

<!--        ì‚¬ìš©ì ìˆ˜ì • ëª¨ë‹¬-->
<div class="modal fade" id="userModifyModal" tabindex="-1" role="dialog" aria-labelledby="userModifyModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userModifyModalLabel">ì‚¬ìš©ì ìˆ˜ì •</h5>
                <button type="button" aria-label="Close" class="closeModalBtn">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="userModifyForm">
                    <div class="form-group">
                        <label for="userName">ì´ë¦„</label>
                        <input type="text" class="form-control" id="modifiedUserName" placeholder="ì´ë¦„ ì…ë ¥">
                    </div>
                    <div class="form-group">
                        <label for="userEmail">ì•„ì´ë””</label>
                        <input type="text" readonly class="form-control" id="modifiedUserEmail" placeholder="ì•„ì´ë”” ì…ë ¥">
                    </div>
                    <div class="form-group">
                        <label for="userPassword">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" class="form-control" id="modifiedUserPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="closeModifyModal">ë‹«ê¸°</button>
                <button type="button" class="btn btn-primary" id="modifyUserBtn">ìˆ˜ì •</button>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="script">
    <script type="text/javascript">
        let dataGridInstance;
        let selectedData;

        function fetchTableData() {
            fetch('http://localhost:8082/bi/user/table')
                .then(response => response.json())
                .then(data => {
                    if (dataGridInstance) {
                        dataGridInstance.option("dataSource", data);
                    }
                })
                .catch(error => console.error('Error fetching data:', error));
        }

        $(document).ready(function() {
            dataGridInstance = $("#dataGrid").dxDataGrid({
                dataSource: [], // ì´ˆê¸°ì—ëŠ” ë¹ˆ ë°ì´í„°
                keyExpr: "userId",
                selection: {
                    mode: "single",
                    allowSelectAll: false,
                    showCheckBoxesMode: "onClick"
                },
                columns: [
                    { dataField: "userId", caption: "ì•„ì´ë””" },
                    { dataField: "username", caption: "ì´ë¦„" },
                    { dataField: "password", caption: "ë¹„ë°€ë²ˆí˜¸" },
                    { dataField: "registeredDate", caption: "ë“±ë¡ ë‚ ì§œ" },
                    { dataField: "registeredUser", caption: "ë“±ë¡ ìœ ì €" },
                    { dataField: "updateDate", caption: "ê°±ì‹  ì¼ì" },
                    { dataField: "updatedUser", caption: "ê°±ì‹  ìœ ì €" },
                    { dataField: "useYN", caption: "ì¡´ì¬ ì—¬ë¶€" }
                ],
                noDataText: "ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.",
                onSelectionChanged: function(data){
                    selectedData = data.selectedRowsData[0]

                }
            }).dxDataGrid("instance");

            // ì¡°íšŒ ë²„íŠ¼ í´ë¦­ ì‹œ ë°ì´í„° ì¡°íšŒ
            $("#fetchUser").on("click", function() {
                fetchTableData();
            });

            // ë“±ë¡ ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë‹¬ ì—´ê¸°
            $("#openRegisterModal").on("click", function() {
                $("#userRegisterModal").modal("show");
                $("#userRegisterForm")[0].reset(); // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            });

            // ë“±ë¡ ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ (ë‹«ê¸° ë²„íŠ¼)
            $("#closeRegisterModal").on("click", function() {
                $("#userRegisterModal").modal("hide");
            });

            // ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë‹¬ ì—´ê¸°
            $("#openModifyModal").on("click", function() {
                if (!selectedData) {
                    alert("í•„ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”")
                    return
                }
                selectedData = dataGridInstance.getSelectedRowsData()[0]
                $("#userModifyModal").modal("show");

                // ì „ì—­ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜¤ì§€ ë§ê³  í…Œì´ë¸”ì˜ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ê²ƒ
                $("#modifiedUserEmail").val(selectedData?.userId);
                $("#modifiedUserName").val(selectedData?.username);
                $("#modifiedUserPassword").val(selectedData?.password);
            });

            // ìˆ˜ì • ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ (ë‹«ê¸° ë²„íŠ¼)
            $("#closeModifyModal").on("click", function() {
                $("#userModifyModal").modal("hide");
            });

            $(".closeModalBtn").on("click", function() {
                $("#userRegisterModal").modal("hide");
                $("#userModifyModal").modal("hide");
            });

            // ë“±ë¡ ë²„íŠ¼ í´ë¦­ ì‹œ í¼ ë°ì´í„° ì €ì¥
            $("#saveUserBtn").on("click", function() {
                const userName = $("#userName").val();
                const userEmail = $("#userEmail").val();
                const userPassword = $("#userPassword").val();

                if (!userName || !userEmail || !userPassword) {
                    alert("ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }

                const userData = {
                    username: userName,
                    userId: userEmail,
                    password: userPassword
                };


                $.ajax({
                    url: "http://localhost:8082/bi/user/regiUser",  // ğŸ“Œ ë°±ì—”ë“œ API ì—”ë“œí¬ì¸íŠ¸
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(userData),
                    success: function(response) {
                        alert("ì‚¬ìš©ìê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        $("#userRegisterModal").modal("hide"); // ëª¨ë‹¬ ë‹«ê¸°
                        $("#userRegisterForm")[0].reset(); // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                        fetchTableData();
                    },
                    error: function(xhr, status, error) {
                        console.error("ì‚¬ìš©ì ë“±ë¡ ì‹¤íŒ¨:", xhr.responseText);
                        alert("ì‚¬ìš©ì ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    }
                });
            });

            // ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì‹œ ìƒˆë¡œìš´ í¼ ë°ì´í„° ì €ì¥
            $("#modifyUserBtn").on("click", function() {
                const userName = $("#modifiedUserName").val();
                const userEmail = $("#modifiedUserEmail").val();
                const userPassword = $("#modifiedUserPassword").val();

                if (!userName || !userEmail || !userPassword) {
                    alert("ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }

                const userData = {
                    username: userName,
                    userId: userEmail,
                    password: userPassword
                };



               if (confirm("ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){
                   $.ajax({
                        url: "http://localhost:8082/bi/user/update",  // ğŸ“Œ ë°±ì—”ë“œ API ì—”ë“œí¬ì¸íŠ¸
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(userData),
                        success: function(response) {
                            alert("ì‚¬ìš©ìê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                            $("#userModifyModal").modal("hide"); // ëª¨ë‹¬ ë‹«ê¸°
                            fetchTableData();
                        },
                        error: function(xhr, status, error) {
                            console.error("ì‚¬ìš©ì ìˆ˜ì • ì‹¤íŒ¨:", xhr.responseText);
                            alert("ì‚¬ìš©ì ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                        }
                   });
               }
            });

            // ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ ë°ì´í„° ì‚­ì œ
            $("#deleteUser").on("click", function() {
                const userName = selectedData?.username;
                const userEmail = selectedData?.userId;
                const userPassword = selectedData?.password;

                if (!userName || !userEmail || !userPassword) {
                    alert("ì‚­ì œí•  í•„ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                    return;
                }

                const userData = {
                    username: userName,
                    userId: userEmail,
                    password: userPassword
                };

                console.log(userData);

                if (confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){
                    $.ajax({
                        url: "http://localhost:8082/bi/user/delete",  // ğŸ“Œ ë°±ì—”ë“œ API ì—”ë“œí¬ì¸íŠ¸
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(userData),
                        success: function(response) {
                            alert("ì‚¬ìš©ìê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                            fetchTableData();
                        },
                        error: function(xhr, status, error) {
                            console.error("ì‚¬ìš©ì ì‚­ì œ ì‹¤íŒ¨:", xhr.responseText);
                            alert("ì‚¬ìš©ì ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                        }
                    });
                }
            });
        });
    </script>
    <script type="text/javascript" src="https://cdn3.devexpress.com/jslib/24.2.5/js/dx.all.js">

    </script>
</th:block>


</body>
</html>