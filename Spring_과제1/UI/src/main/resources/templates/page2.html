<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default}">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn3.devexpress.com/jslib/24.2.5/css/dx.light.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="dx-viewport">
<div th:fragment="content">
    <div class="content container-fluid">
        <div>ë©”ë‰´ í˜ì´ì§€</div>
        <div class="box">
            <div class="box-header with-bordered">
                <div class="box-body">
                    <button id="fetchMenu" onclick="fetchMenuData()">ì¡°íšŒ</button>
                    <button id="openRegisterModal">ë“±ë¡</button>
                    <button id="deleteMenu">ì‚­ì œ</button>
                </div>
                <hr/>
                <table id="dataGrid">
                    <thead id="data-table-header"></thead>
                    <tbody id="data-table-body"></tbody>
                </table>
            </div>

        </div>
    </div>
</div>

<!-- ë©”ë‰´ ë“±ë¡ ëª¨ë‹¬ -->
<div class="modal fade" id="menuRegisterModal" tabindex="-1" role="dialog" aria-labelledby="menuRegisterModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="menuRegisterModalLabel">ë©”ë‰´ ë“±ë¡</h5>
                <button type="button" aria-label="Close" class="closeModalBtn">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="menuRegisterForm">
                    <div class="form-group">
                        <label for="registeredUser">ì•„ì´ë””</label>
                        <input type="text" class="form-control" id="registeredUser" placeholder="ì•„ì´ë”” ì…ë ¥">
                    </div>
                    <div class="form-group">
                        <label for="menuname">ì´ë¦„</label>
                        <input type="text" class="form-control" id="menuname" placeholder="ì´ë¦„ ì…ë ¥">
                    </div>
                    <div class="form-group">
                        <label for="upperMenuId">ìƒìœ„ ë©”ë‰´ ì•„ì´ë””</label>
                        <input type="text" class="form-control" id="upperMenuId" placeholder="ìƒìœ„ ë©”ë‰´ ì•„ì´ë”” ì…ë ¥">
                    </div>
                    <div class="form-group">
                        <label for="url">url</label>
                        <input type="text" class="form-control" id="url" placeholder="url ì…ë ¥">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="closeRegisterModal">ë‹«ê¸°</button>
                <button type="button" class="btn btn-primary" id="saveMenuBtn">ë“±ë¡</button>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="script">
    <script type="text/javascript">
        let dataGridInstance;
        let selectedData;

        function fetchMenuData() {
             const urlForAllData = new URL('http://localhost:12400/menu/bi/menu/table');
             fetch(urlForAllData)
                .then(response => response.json())
                .then(data => {
                    if (dataGridInstance) {
                        dataGridInstance.option("dataSource", data);
                    }
                })
                .catch(error => console.error('Error fetching data:', error));
        }

        $(document).ready(function() {
            dataGridInstance = $("#dataGrid").dxTreeList({
                dataSource: [], // ì´ˆê¸°ì—ëŠ” ë¹ˆ ë°ì´í„°
                keyExpr: "menuId",
                parentIdExpr: "upperMenuId",
                selection: {
                    mode: "single",
                    allowSelectAll: false,
                    showCheckBoxesMode: "onClick"
                },
                columns: [
                    { dataField: "menuId", caption: "ì•„ì´ë””", alignment: "left"},
                    { dataField: "menuname", caption: "ì´ë¦„" },
                    { dataField: "sort", caption: "ì†ŒíŠ¸" },
                    { dataField: "upperMenuId", caption: "ìƒìœ„ ë©”ë‰´ ì•„ì´ë””" },
                    { dataField: "url", caption: "URL" },
                    { dataField: "useYN", caption: "ì¡´ì¬ ì—¬ë¶€" },
                    { dataField: "registeredDate", caption: "ë“±ë¡ ë‚ ì§œ" },
                    { dataField: "registeredUser", caption: "ë“±ë¡ ìœ ì €" },
                    { dataField: "updatedDate", caption: "ìˆ˜ì • ë‚ ì§œ" },
                    { dataField: "updatedUser", caption: "ìˆ˜ì • ìœ ì €" }
                ],
                noDataText: "ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.",
                onSelectionChanged: function(data){
                    selectedData = data.selectedRowsData[0]
                    console.log(selectedData?.menuId);
                }
            }).dxTreeList("instance");

            // ì¡°íšŒ ë²„íŠ¼ í´ë¦­ ì‹œ ë°ì´í„° ì¡°íšŒ
            $("#fetchMenu").on("click", function() {
                fetchMenuData();
            });

            // ë“±ë¡ ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë‹¬ ì—´ê¸°
            $("#openRegisterModal").on("click", function() {
                $("#menuRegisterModal").modal("show");
                $("#menuRegisterForm")[0].reset(); // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            });

            // ë“±ë¡ ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ (ë‹«ê¸° ë²„íŠ¼)
            $("#closeRegisterModal").on("click", function() {
                $("#menuRegisterModal").modal("hide");
            });

            // ë“±ë¡ ë²„íŠ¼ í´ë¦­ ì‹œ í¼ ë°ì´í„° ì €ì¥
            $("#saveMenuBtn").on("click", function() {
                const registeredUser = $("#registeredUser").val();
                const menuname = $("#menuname").val();
                const upperMenuId = $("#upperMenuId").val();
                const url = $("#url").val();

                if (!registeredUser || !menuname || !url) {
                    alert("ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }

                const menuData = {
                    registeredUser,
                    menuname,
                    upperMenuId,
                    url
                };


                $.ajax({
                    url: "http://localhost:12400/menu/bi/menu/regi",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(menuData),
                    success: function(response) {
                        alert("ë©”ë‰´ê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        $("#menuRegisterModal").modal("hide"); // ëª¨ë‹¬ ë‹«ê¸°
                        $("#menuRegisterForm")[0].reset(); // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                        fetchMenuData();
                    },
                    error: function(xhr, status, error) {
                        console.error("ë©”ë‰´ ë“±ë¡ ì‹¤íŒ¨:", xhr.responseText);
                        alert("ë©”ë‰´ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    }
                });
            });

            // ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ ë°ì´í„° ì‚­ì œ
            $("#deleteMenu").on("click", function() {
                const menuId = selectedData?.menuId;

                if (!menuId) {
                    alert("ì‚­ì œí•  í•„ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                    return;
                }

                if (confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){
                    $.ajax({
                        url: `http://localhost:12400/menu/bi/menu/delete?menuId=${menuId}`,  // ğŸ“Œ ë°±ì—”ë“œ API ì—”ë“œí¬ì¸íŠ¸
                        type: "POST",
                        contentType: "application/json",
                        success: function(response) {
                            alert("ì‚¬ìš©ìê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                            fetchMenuData();
                        },
                        error: function(xhr, status, error) {
                            console.error("ë©”ë‰´ ì‚­ì œ ì‹¤íŒ¨:", xhr.responseText);
                            alert("ë©”ë‰´ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                        }
                    });
                }
            });
        });
    </script>
    <script type="text/javascript" src="https://cdn3.devexpress.com/jslib/24.2.5/js/dx.all.js">

    </script>
</th:block>


</body>
</html>